name: Kronos Testing Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  kronos-core-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up JDK 21 ☕️
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'adopt'

      - name: Create badges dir if not exists 📁
        run: mkdir -p .github/badges

      - name: Run Core Test Coverage 🧪
        id: core-coverage
        run: |
          ./gradlew :kronos-core:koverLog --info --stacktrace
          COVERAGE="$(cat kronos-compiler-plugin/build/reports/kover/coverage.txt | grep 'application line coverage' | cut -d' ' -f4)"
          echo "##[set-output name=lines;]${COVERAGE}%"

      - name: Run Compiler Plugin Test Coverage 🧪
        id: compiler-plugin-coverage
        run: |
          ./gradlew :kronos-compiler-plugin:koverLog --info --stacktrace
          COVERAGE="$(cat kronos-compiler-plugin/build/reports/kover/coverage.txt | grep 'application line coverage' | cut -d' ' -f4)"
          echo "##[set-output name=lines;]${COVERAGE}%"

      - name: Generate the badge SVG image for Core
        uses: emibcn/badge-action@v2.0.2
        with:
          label: 'Test coverage'
          status: ${{ steps.core-coverage.outputs.lines }}
          color: 'blue,555,daf'
          path: '.github/badges/coverage-core.svg'

      - name: Generate the badge SVG image for Compiler Plugin
        uses: emibcn/badge-action@v2.0.2
        with:
          label: 'Test coverage'
          status: ${{ steps.compiler-plugin-coverage.outputs.lines }}
          color: 'blue,555,daf'
          path: '.github/badges/coverage-compiler-plugin.svg'

      - name: Deploy to badge branch 📦
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: badge
          folder: .github/badges
          clean: true
          single-commit: true
