# 2. 目录结构与关键类

源码位置：`kronos-compiler-plugin/src/main/kotlin/com/kotlinorm/compiler`

- plugin/
  - KronosParserCompilerPluginRegistrar
    - 继承 CompilerPluginRegistrar，启用 supportsK2。
    - 在 registerExtensions 中读取命令行参数（debug、debug-info-path），注册 IrGenerationExtension。
  - KronosCommandLineProcessor
    - 定义插件 ID：`kronos-compiler-plugin`；
    - 定义两个可选参数：
      - `debug`（Boolean）：是否输出 IR dump；
      - `debug-info-path`（String）：dump 输出目录。
  - KronosParserExtension
    - generate(...) 是编译期入口：
      - resetKClassCreator();
      - module.transform(KronosParserTransformer(...));
      - 回放 initFunctions，调用 buildKClassMapper 生成映射；
      - 若 debug=true，使用 dumpKotlinLike 将 IR 文本写入目录。
  - transformer/KronosParserTransformer
    - visitCall：
      - 记录类型实参中为 KPojo 的类；
      - 捕获带 @KronosInit 的函数表达式，保存到 initFunctions；
      - 针对 TypedQuery/SelectFrom* 调用，执行 updateTypedQueryParameters。
    - visitFunctionNew：
      - 根据扩展接收者类型，分发到 KTableForSelect/Set/Condition/Sort/Reference 的变换；
    - visitClassNew/visitClassReference/visitConstructorCall：
      - 收集所有 KPojo 子类；
- transformer/kTable/
  - KTableParserForSelectTransformer
    - 在函数返回前注入 addFieldList(...) 调用，对选择字段进行收集；
  - KTableParserForSetTransformer、KTableParserForConditionTransformer、KTableParserForSortReturnTransformer、KTableParserForReferenceTransformer
    - 分别处理 set、条件、排序、引用等 DSL 片段，对 IR 进行替换/增强；
- utils/
  - KClassCreatorUtil：
    - initFunctions：保存 @KronosInit 收集到的初始化函数；
    - buildKClassMapper(...)：在编译末尾生成 KClass 映射；
    - kPojoClasses：缓存收集到的 KPojo 类；
  - Ir*Helper：
    - 提供 IR 构造/遍历的辅助方法，降低 Transformer 的复杂度；
  - KTableFor*Util：
    - 提供 addFieldList、条件合成、排序注入等工具函数；
  - updateTypedQueryParameters
    - 对 TypedQuery/SelectFrom* 做类型参数修正，避免类型缺失。
