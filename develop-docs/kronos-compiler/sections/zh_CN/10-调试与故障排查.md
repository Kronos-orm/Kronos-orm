# 10. 调试与故障排查

## 10.1 开启 IR dump

- Gradle/Maven 中加入：
  - `-P plugin:kronos-compiler-plugin:debug=true`
  - `-P plugin:kronos-compiler-plugin:debug-info-path=<目录>`（可选，默认 `build/tmp/kronosIrDebug`）
- 编译后检查目录，按文件名定位对应源文件的 IR 文本。

## 10.2 常见问题

- 未启用 K2
  - 该插件基于 K2 的 IR 接口，确保使用支持 K2 的 Kotlin 版本；
- 找不到插件或参数无效
  - 检查 `-Xplugin` 与 `plugin:kronos-compiler-plugin:*` 参数是否配置正确；
  - 确认插件 jar 已进入编译器类路径（compileOnly 或 kotlinCompilerPluginClasspath 等方式）；
- 运行时报错但 IR dump 正常
  - 优先在测试中最小化输入复现，核对 IR 改写逻辑是否与运行时 API 对齐；
- IR 转换出现 NPE 或 ClassCast
  - 通过 dump 精确定位是哪一步注入的 IR 片段不符合期望；
  - 对可空/泛型边界/扩展接收者等场景提高健壮性；

## 10.3 最佳实践

- 每引入一个新 Transformer 或规则，都应增加单测覆盖；
- 将易变的 IR 构造逻辑封装到 util 层，降低重复代码与出错概率；
- 合理使用日志与 dump；避免在生产构建中长期开启 debug。