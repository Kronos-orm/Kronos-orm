


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>kronos-compiler-plugin Coverage Report > KClassCreatorUtil</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: kronos-compiler-plugin<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.kotlinorm.compiler.plugin.utils</a>
</div>

<h1>Coverage Summary for Class: KClassCreatorUtil (com.kotlinorm.compiler.plugin.utils)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">KClassCreatorUtil</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (8/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (3/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (56/56)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    98.8%
  </span>
  <span class="absValue">
    (327/331)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/**
&nbsp; * Copyright 2022-2025 kronos-orm
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *     http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package com.kotlinorm.compiler.plugin.utils
&nbsp;
&nbsp;import com.kotlinorm.compiler.helpers.instantiate
&nbsp;import com.kotlinorm.compiler.helpers.invoke
&nbsp;import com.kotlinorm.compiler.helpers.kFunctionN
&nbsp;import com.kotlinorm.compiler.helpers.nType
&nbsp;import com.kotlinorm.compiler.helpers.toKClass
&nbsp;import com.kotlinorm.compiler.helpers.valueParameters
&nbsp;import org.jetbrains.kotlin.backend.common.extensions.IrPluginContext
&nbsp;import org.jetbrains.kotlin.backend.common.lower.createIrBuilder
&nbsp;import org.jetbrains.kotlin.descriptors.DescriptorVisibilities
&nbsp;import org.jetbrains.kotlin.descriptors.Modality
&nbsp;import org.jetbrains.kotlin.ir.UNDEFINED_OFFSET
&nbsp;import org.jetbrains.kotlin.ir.builders.IrBlockBuilder
&nbsp;import org.jetbrains.kotlin.ir.builders.IrBuilderWithScope
&nbsp;import org.jetbrains.kotlin.ir.builders.declarations.IrValueParameterBuilder
&nbsp;import org.jetbrains.kotlin.ir.builders.declarations.buildFun
&nbsp;import org.jetbrains.kotlin.ir.builders.declarations.buildValueParameter
&nbsp;import org.jetbrains.kotlin.ir.builders.irBlockBody
&nbsp;import org.jetbrains.kotlin.ir.builders.irBranch
&nbsp;import org.jetbrains.kotlin.ir.builders.irElseBranch
&nbsp;import org.jetbrains.kotlin.ir.builders.irEquals
&nbsp;import org.jetbrains.kotlin.ir.builders.irGet
&nbsp;import org.jetbrains.kotlin.ir.builders.irNull
&nbsp;import org.jetbrains.kotlin.ir.builders.irReturn
&nbsp;import org.jetbrains.kotlin.ir.builders.irWhen
&nbsp;import org.jetbrains.kotlin.ir.declarations.IrClass
&nbsp;import org.jetbrains.kotlin.ir.declarations.IrDeclarationOrigin
&nbsp;import org.jetbrains.kotlin.ir.declarations.IrFunction
&nbsp;import org.jetbrains.kotlin.ir.declarations.IrParameterKind
&nbsp;import org.jetbrains.kotlin.ir.declarations.IrSimpleFunction
&nbsp;import org.jetbrains.kotlin.ir.expressions.IrFunctionExpression
&nbsp;import org.jetbrains.kotlin.ir.expressions.IrStatementOrigin
&nbsp;import org.jetbrains.kotlin.ir.expressions.impl.IrFunctionExpressionImpl
&nbsp;import org.jetbrains.kotlin.ir.symbols.UnsafeDuringIrConstructionAPI
&nbsp;import org.jetbrains.kotlin.ir.types.IrType
&nbsp;import org.jetbrains.kotlin.ir.types.typeWith
&nbsp;import org.jetbrains.kotlin.ir.util.allParameters
&nbsp;import org.jetbrains.kotlin.ir.util.fqNameWhenAvailable
&nbsp;import org.jetbrains.kotlin.ir.util.statements
&nbsp;import org.jetbrains.kotlin.name.CallableId
&nbsp;import org.jetbrains.kotlin.name.FqName
&nbsp;import org.jetbrains.kotlin.name.Name
&nbsp;import org.jetbrains.kotlin.name.SpecialNames
&nbsp;
&nbsp;object KClassCreatorUtil {
<b class="fc">&nbsp;    val kPojoClasses = mutableSetOf&lt;IrClass&gt;()</b>
<b class="fc">&nbsp;    val initFunctions = mutableSetOf&lt;Triple&lt;IrPluginContext, IrBuilderWithScope, IrFunction&gt;&gt;()</b>
&nbsp;    fun resetKClassCreator() {
<b class="fc">&nbsp;        kPojoClasses.clear()</b>
<b class="fc">&nbsp;        initFunctions.clear()</b>
&nbsp;    }
&nbsp;
&nbsp;    context(context: IrPluginContext)
&nbsp;    private val kClassCreatorSymbol
<b class="fc">&nbsp;        get() = context.referenceProperties(</b>
<b class="fc">&nbsp;            CallableId(</b>
<b class="fc">&nbsp;                packageName = FqName(&quot;com.kotlinorm.utils&quot;),</b>
<b class="fc">&nbsp;                callableName = Name.identifier(&quot;kClassCreator&quot;)</b>
&nbsp;            )
<b class="fc">&nbsp;        ).first()</b>
&nbsp;
&nbsp;    @OptIn(UnsafeDuringIrConstructionAPI::class)
&nbsp;    context(_: IrPluginContext)
&nbsp;    private val kClassCreatorSetterSymbol
<b class="fc">&nbsp;        get() = kClassCreatorSymbol.owner.setter!!.symbol</b>
&nbsp;
&nbsp;    context(_: IrPluginContext)
&nbsp;    private fun lambdaArgument(
&nbsp;        lambda: IrSimpleFunction,
<b class="fc">&nbsp;        type: IrType = kFunctionN(lambda.allParameters.size).typeWith(lambda.allParameters.map { it.type } + lambda.returnType),</b>
<b class="fc">&nbsp;        startOffset: Int = UNDEFINED_OFFSET,</b>
<b class="fc">&nbsp;        endOffset: Int = UNDEFINED_OFFSET</b>
<b class="fc">&nbsp;    ): IrFunctionExpression = IrFunctionExpressionImpl(</b>
<b class="fc">&nbsp;        startOffset,</b>
<b class="fc">&nbsp;        endOffset,</b>
<b class="fc">&nbsp;        type,</b>
<b class="fc">&nbsp;        lambda,</b>
<b class="fc">&nbsp;        IrStatementOrigin.LAMBDA</b>
&nbsp;    )
&nbsp;
&nbsp;    context(_: IrPluginContext, builder: IrBuilderWithScope)
&nbsp;    fun buildKClassMapper(declaration: IrFunction) {
<b class="fc">&nbsp;        declaration.body = builder.irBlockBody {</b>
<b class="fc">&nbsp;            val lambda = context.irFactory.buildFun {</b>
<b class="fc">&nbsp;                origin = IrDeclarationOrigin.LOCAL_FUNCTION_FOR_LAMBDA</b>
<b class="fc">&nbsp;                name = SpecialNames.ANONYMOUS</b>
<b class="fc">&nbsp;                visibility = DescriptorVisibilities.LOCAL</b>
<b class="fc">&nbsp;                returnType = KPojoSymbol.nType</b>
<b class="fc">&nbsp;                modality = Modality.FINAL</b>
<b class="fc">&nbsp;            }.apply {</b>
<b class="fc">&nbsp;                parent = declaration</b>
<b class="fc">&nbsp;                parameters = parameters + context.irFactory.buildValueParameter(IrValueParameterBuilder().apply {</b>
<b class="fc">&nbsp;                    name = Name.identifier(&quot;kClass&quot;)</b>
<b class="fc">&nbsp;                    type = KPojoSymbol.toKClass().type // KClass&lt;KPojo&gt;</b>
<b class="fc">&nbsp;                    kind = IrParameterKind.Regular</b>
<b class="fc">&nbsp;                }, this)</b>
<b class="fc">&nbsp;                body = context.irBuiltIns.createIrBuilder(symbol).run {</b>
<b class="fc">&nbsp;                    irBlockBody {</b>
<b class="fc">&nbsp;                        +irReturn(</b>
<b class="fc">&nbsp;                            irWhen(</b>
<b class="fc">&nbsp;                                KPojoSymbol.nType,</b>
<b class="fc">&nbsp;                                kPojoClasses.distinctBy { it.fqNameWhenAvailable }.mapNotNull {</b>
<b class="pc">&nbsp;                                    it.symbol.instantiate()?.let { new -&gt;</b>
<b class="fc">&nbsp;                                        irBranch(</b>
<b class="fc">&nbsp;                                            irEquals(</b>
<b class="fc">&nbsp;                                                irGet(parameters.valueParameters.first()),</b>
<b class="fc">&nbsp;                                                it.symbol.toKClass()</b>
&nbsp;                                            ),
<b class="fc">&nbsp;                                            new</b>
<b class="fc">&nbsp;                                        )</b>
<b class="fc">&nbsp;                                    }</b>
<b class="fc">&nbsp;                                } + irElseBranch(</b>
<b class="fc">&nbsp;                                    irNull()</b>
&nbsp;                                )
&nbsp;                            )
&nbsp;                        )
<b class="fc">&nbsp;                    }</b>
&nbsp;                }
<b class="fc">&nbsp;            }</b>
&nbsp;
<b class="fc">&nbsp;            +kClassCreatorSetterSymbol(</b>
<b class="fc">&nbsp;                lambdaArgument(lambda),</b>
<b class="fc">&nbsp;                operator = IrStatementOrigin.EQ</b>
&nbsp;            )
<b class="pc">&nbsp;            declaration.body?.statements?.forEach { +it }</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-10-22 15:27</div>
</div>
</body>
</html>
